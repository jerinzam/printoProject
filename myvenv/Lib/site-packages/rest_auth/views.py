from django.contrib.auth import login, logout
from django.conf import settings

from rest_framework import status
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.generics import GenericAPIView
from rest_framework.permissions import IsAuthenticated, AllowAny
from rest_framework.authtoken.models import Token
from rest_framework.generics import RetrieveUpdateAPIView

from .app_settings import (
    TokenSerializer, UserDetailsSerializer, LoginSerializer,
    PasswordResetSerializer, PasswordResetConfirmSerializer,
    PasswordChangeSerializer
)

from django.middleware import csrf 
from allauth.account.models import EmailAddress
from django.http import HttpResponseRedirect
from rest_framework.parsers import MultiPartParser, FormParser
from userroles.models import UserRole
from userroles import roles
from api.models import Shop

class user_auth(APIView):
    def update_csrf(self):
        # import ipdb; ipdb.set_trace();
        new_csrf = csrf.get_token(self.request)
        return new_csrf
    def get(self,request):
        # import ipdb; ipdb.set_trace();
        if(request.user.role == roles.owner):
            if(request.user.is_authenticated() & EmailAddress.objects.get(email=request.user.email).verified):
                return Response({'auth':True,'user' : request.user.username,'user_role':request.user.role.name},status=status.HTTP_200_OK) 
        elif(request.user.role == roles.employee):   
             if(request.user.is_authenticated()):
                return Response({'auth':True,'user' : request.user.username,'user_role':request.user.role.name},status=status.HTTP_200_OK) 
        else:
            return Response({'auth':False,'csrf_token' : self.update_csrf() },status=status.HTTP_401_UNAUTHORIZED)
        


class LoginView(GenericAPIView):

    """
    Check the credentials and return the REST Token
    if the credentials are valid and authenticated.
    Calls Django Auth login method to register User ID
    in Django session framework

    Accept the following POST parameters: username, password
    Return the REST Framework Token Object's key.
    """
    permission_classes = (AllowAny,)
    serializer_class = LoginSerializer
    token_model = Token
    response_serializer = TokenSerializer

    def login(self):
        # import ipdb; ipdb.set_trace()
        self.user = self.serializer.validated_data['user']
        self.token, created = self.token_model.objects.get_or_create(
            user=self.user)
        
        if getattr(settings, 'REST_SESSION_LOGIN', True):
            # import ipdb; ipdb.set_trace();
            if(self.user.role == roles.owner):
                if(EmailAddress.objects.get(email=self.user.email).verified):
                    login(self.request, self.user)
                    self.auth = True
                else:
                    self.auth = False
            elif(self.user.role == roles.employee):
                login(self.request, self.user)
                self.auth = True
            else:
                self.auth = False
           
            
    def update_csrf(self):
        # import ipdb; ipdb.set_trace();
        new_csrf = csrf.get_token(self.request)
        return new_csrf
                
    def get_response(self):
        # import ipdb; ipdb.set_trace();
        username = self.user.username
        email = self.user.email
        if self.auth:
            # import ipdb; ipdb.set_trace();
            self.auth = False
            if(self.user.role == roles.owner):
                return Response({ "auth":True,"user":username,"role":self.user.role.name,"csrf_token":self.update_csrf(),
                    "token":self.response_serializer(self.token).data } , status=status.HTTP_200_OK
                )
            if(self.user.role == roles.employee):

                shop = Shop.objects.get(employee=self.user)
                return Response({ "auth":True,"user":username,"role":self.user.role.name,"shopname":shop.shopName,"csrf_token":self.update_csrf(),
                    "token":self.response_serializer(self.token).data } , status=status.HTTP_200_OK
                )
        else:
            return Response({ "auth":False,"user":"unverified user","csrf_token":self.update_csrf(),
                "token":self.response_serializer(self.token).data } , status=status.HTTP_200_OK
            )


    def get_error_response(self):
        return Response(
            self.serializer.errors, status=status.HTTP_400_BAD_REQUEST
        )

    def post(self, request, *args, **kwargs):
        print("in post of LoginView:")
        # import ipdb; ipdb.set_trace()
        self.serializer = self.get_serializer(data=self.request.data)
        if not self.serializer.is_valid():
            return self.get_error_response()
        self.login()
        return self.get_response()

class LogoutView(APIView):

    """
    Calls Django logout method and delete the Token object
    assigned to the current User object.

    Accepts/Returns nothing.
    """
    permission_classes = (AllowAny,)

    def update_csrf(self):
        new_csrf = csrf.get_token(self.request)
        return new_csrf

    def post(self, request):
        try:
            request.user.auth_token.delete()
        except:
            pass
        # import ipdb; ipdb.set_trace()    
        logout(request)

        return Response({"csrf_token":self.update_csrf(),"success": "Successfully logged out."},
                        status=status.HTTP_200_OK)


class UserDetailsView(RetrieveUpdateAPIView):

    """
    Returns User's details in JSON format.

    Accepts the following GET parameters: token
    Accepts the following POST parameters:
        Required: token
        Optional: email, first_name, last_name and UserProfile fields
    Returns the updated UserProfile and/or User object.
    """
    serializer_class = UserDetailsSerializer
    permission_classes = (IsAuthenticated,)
    parser_classes = (MultiPartParser, FormParser,)

    def get_object(self):
        # import ipdb; ipdb.set_trace()
        return self.request.user

    def update(self, request, *args, **kwargs):
        # partial = kwargs.pop('partial', False)
        # import ipdb; ipdb.set_trace();
        instance = self.get_object()
        serializer = self.get_serializer(instance, data=request.data, partial=True)
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)
        return Response(serializer.data)


class PasswordResetView(GenericAPIView):

    """
    Calls Django Auth PasswordResetForm save method.

    Accepts the following POST parameters: email
    Returns the success/fail message.
    """

    serializer_class = PasswordResetSerializer
    permission_classes = (AllowAny,)

    def post(self, request, *args, **kwargs):
        # Create a serializer with request.data
        import ipdb; ipdb.set_trace()
        serializer = self.get_serializer(data=request.data)

        if not serializer.is_valid():
            return Response(serializer.errors,
                            status=status.HTTP_400_BAD_REQUEST)
        serializer.save()
        # Return the success message with OK HTTP status
        return Response(
            {"success": "Password reset e-mail has been sent."},
            status=status.HTTP_200_OK
        )


class PasswordResetConfirmView(GenericAPIView):

    """
    Password reset e-mail link is confirmed, therefore this resets the user's password.

    Accepts the following POST parameters: new_password1, new_password2
    Accepts the following Django URL arguments: token, uid
    Returns the success/fail message.    
    """

    serializer_class = PasswordResetConfirmSerializer
    permission_classes = (AllowAny,)

    def get(self, request,uidb64,token):
        import ipdb; ipdb.set_trace();
        return HttpResponseRedirect('/printo/#pwdreset/'+uidb64+'/'+token)

    def post(self, request):
        import ipdb; ipdb.set_trace();
        serializer = self.get_serializer(data=request.data)
        if not serializer.is_valid():
            return Response(
                serializer.errors, status=status.HTTP_400_BAD_REQUEST
            )
        serializer.save()
        return Response({"success": "Password has been reset with the new password."})
       


class PasswordChangeView(GenericAPIView):

    """
    Calls Django Auth SetPasswordForm save method.

    Accepts the following POST parameters: new_password1, new_password2
    Returns the success/fail message.
    """

    serializer_class = PasswordChangeSerializer
    permission_classes = (IsAuthenticated,)

    def post(self, request):
        serializer = self.get_serializer(data=request.data)
        if not serializer.is_valid():
            return Response(
                serializer.errors, status=status.HTTP_400_BAD_REQUEST
            )
        serializer.save()
        return Response({"success": "New password has been saved."})
